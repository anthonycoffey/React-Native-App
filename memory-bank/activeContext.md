# Active Context

This document details the current work focus, recent changes, next steps, active decisions and considerations, important patterns and preferences, learnings, and project insights.

## Current Work Focus

Enhancing background location tracking reliability for fleet monitoring.

## Recent Changes

- **Architectural Refactor: Global Location Tracking:**
  - Migrated location tracking logic from `hooks/useLocation.ts` to a new `LocationContext` (`contexts/LocationContext.tsx`).
  - Wrapped the entire application (within `app/_layout.tsx`) with `LocationProvider`.
  - **Impact:** This ensures that location tracking (both background and foreground) is active and managed whenever the user is logged in and the app is running, regardless of which screen they are viewing (e.g., "My Jobs" vs "Go Online"). Previously, tracking was only active when the `useLocation` hook was explicitly mounted, which primarily happened on the "Go Online" screen.
  - Updated `hooks/useLocation.ts` to serve as a wrapper around `useLocationContext`, preserving the existing API for components like `GoOnlineScreen`.
- **Extensive Logging for Location Service:**
  - Added detailed logging to `contexts/LocationContext.tsx` to track the lifecycle of the location service:
    - `[LocationProvider] Initialized`
    - `[LocationProvider] AppState changed: ...`
    - `[BackgroundLocation] Task triggered`
    - `[BackgroundLocation] Sending POST request to /user/geolocation at [TIMESTAMP]`
    - `[BackgroundLocation] API update success/failed`
  - These logs provide visibility into when the app enters the background and precisely when API requests are fired, aiding in debugging and verification of fleet monitoring features.
- **Hardened Background Auth Token Retrieval:**
  - Updated `hooks/useStorageState.ts` to set `keychainAccessible: SecureStore.ALWAYS_THIS_DEVICE_ONLY` when saving the session token. This ensures the token remains accessible to the background task even when the device is locked (screen off).
  - Added error handling (try-catch) around `SecureStore.getItemAsync` in the background task to prevent crashes.
- **Redesigned Background Location Tracking:**
  - **Unified Logic:** The background task is now the *only* source of server updates, preventing "split brain" issues with the foreground watcher.
  - **Fleet Monitoring Config:** Tuned parameters (`distanceInterval: 50m`, `timeInterval: 30s`) for better responsiveness.
  - **Robustness:** Added persistence checks for clock-in status and smart throttling to preventing server flooding.
  - **Removed Throttling:** Completely removed the 15-second throttle from the background task to ensure all valid updates are processed and sent to the server, prioritizing tracking accuracy over bandwidth conservation during this debugging phase.

- **Implemented Tappable In-App Notifications:**
  - Extended the deep linking functionality to the in-app notifications screen (`app/dashboard/notifications.tsx`).
  - Updated `hooks/useNotifications.ts` to store the `link` from the notification payload along with other notification data.
  - Modified `app/dashboard/notifications.tsx` to make each notification item tappable, navigating to the stored `link` if it exists.
- **Implemented Push Notification Deep Linking:**
  - Added logic to `hooks/useNotifications.ts` to handle deep linking when a user taps a push notification.
  - The `addNotificationResponseReceivedListener` now extracts a `link` property from the notification's data payload.
  - If a `link` is present, it uses `router.push(link as any)` to navigate the user to the specified screen (e.g., a job details page).
  - The link format is `phoenix-mobile:///job/[JOB_ID]`.
  - This functionality is now documented in `memory-bank/systemPatterns.md`.
- **Standardized Section Titles:**
  - Refactored all section titles in `components/job/` to use the standardized `CardTitle` component from `components/Typography.tsx`.
  - Removed local title styles from `components/job/JobComments.tsx` and `components/job/JobFiles.tsx`.
  - Applied style overrides to `CardTitle` where necessary to handle different alignments (e.g., left-aligned titles next to icons).
- **Encapsulated Job Components in Cards:**
  - Refactored all components on the job details page (`app/job/[id].tsx`) to be self-contained cards.
  - Each component now wraps its content in the `<Card>` component, making them more modular and reusable.
  - Cleaned up `app/job/[id].tsx` by removing the redundant `<Card>` wrappers.
- **Modernized Job Page Layout:**
  - Refactored the `app/job/[id].tsx` page to use the standardized `Card` component for all sections, creating a consistent and modern layout.
  - Removed old card styles from child components (`JobStatus`, `JobProxy`, etc.) to prevent style conflicts and improve code maintainability.
- **Standardized App Theme:**
  - Created a custom theme in `app/_layout.tsx` to ensure consistent header and background colors across all screens, fully supporting both light and dark modes.
  - Set the header background to white in light mode and a dark gray in dark mode.
  - Set the page background to a light gray in light mode and a darker gray in dark mode.
- **Fixed Layout Inconsistencies:**
  - Removed horizontal padding from the main `ScrollView` in `app/dashboard/account/index.tsx` to allow the background color to span the full width of the screen, matching other pages.
- **Improved Visual Hierarchy:**
  - Changed the background color of the light theme to a light gray (`#f0f0f0`) in `constants/Colors.ts`.
  - Updated the `Card.tsx` component to use the `card` color from the theme, which is now white (`#ffffff`) in light mode. This creates a clear distinction between the page background and the cards.
- **Redesigned Deposits Page:**
  - Refactored the deposits list screen (`app/dashboard/account/deposits/index.tsx`) to use a card-based layout.
  - Each deposit is now displayed in a theme-aware `Card` component.
  - Added `MaterialIcons` to improve scannability of information (receipt, amount, date, etc.).
  - Improved the visual hierarchy and spacing for a more modern and intuitive look and feel.
- Initialized all core Memory Bank files.
- Populated `projectbrief.md` with core requirements and project goals.
- Populated `productContext.md` with problem statement, solution, and UX goals.
- Populated `systemPatterns.md` with initial architectural details, technical decisions, and patterns.
- Populated `techContext.md` using user input and information from `README.md`.
- Updated `progress.md` to reflect the current state of Memory Bank population.
- Implemented file upload, view, and delete functionality in `components/job/JobFiles.tsx` and integrated into `app/job/[id].tsx`.
- Conducted a comprehensive review of all components in the `components/` directory (root and `job/` subdirectory).
- Updated `systemPatterns.md` with detailed findings from the component review.
- **Updated `components/job/JobFiles.tsx`:**
  - Replaced `TouchableOpacity` with `PrimaryButton` in the `FileViewerModal` for the close action.
  - Changed the file list display to a gallery format for image files, showing previews. Non-image files are still displayed in a list format.
- **Implemented Job Comment Functionality:**
  - Added `JobComment` type to `types.ts`.
  - Created `CommentItem.tsx`, `CommentModal.tsx`, and `CommentsList.tsx` components.
  - Integrated comment viewing, adding, editing, and deleting into `app/job/[id].tsx`.
  - Updated `CommentsList.tsx` to use `map` instead of `FlatList` to avoid nested VirtualizedList issues.
  - Made the comments section in `app/job/[id].tsx` collapsible.
  - Added client-side pagination to `CommentsList.tsx`.
- **Resolved 401 Error for User Fetching:**
  - Resolved an initial 401 error by ensuring user data fetching waited for the session to be established and authorization header to be set in `apiService`.
- **Architectural Refactor: Migrated User Data Fetching to AuthContext:**
  - To definitively resolve race conditions with user data fetching (`/users/me`), the responsibility for fetching and managing `currentUser` has been moved from `UserContext.tsx` to `AuthContext.tsx`.
  - `AuthContext.tsx` now:
    - Defines a comprehensive `User` interface.
    - Fetches user data when a `session` becomes active (which also triggers setting the token in `apiService`).
    - Manages `currentUser` and `isUserLoading` states.
  - `UserContext.tsx` has been simplified to only manage non-authentication-related user state (e.g., `isClockedIn`). It no longer handles `currentUser` or its fetching.
  - Components previously using `currentUser` from `useUser()` (e.g., `app/job/[id].tsx`) have been updated to use `currentUser` from `useAuth()`.
  - This change centralizes authentication and user identity management, providing a more robust and synchronized state.
  - A temporary 5-second delay (used for earlier diagnosis) was removed from `UserContext.tsx` as part of this refactor.
- **Updated `components/job/CommentItem.tsx` for Edit/Delete Buttons:**
  - Replaced text-based `PrimaryButton` and `SecondaryButton` with smaller, iconic buttons using `MaterialIcons` (`edit` and `delete`) wrapped in `TouchableOpacity`.
  - Ensured icons use theme-aware colors (`useThemeColor` for edit icon, `buttonVariants.error` from `constants/Colors` for delete icon).
  - Corrected `User` type import from `contexts/UserContext` to `contexts/AuthContext`.
- **Updated Job Cancellation Dialog in `components/job/JobStatus.tsx`:**
  - Arranged "Go Back" and "Cancel Job" buttons in a row with space-between justification for left/right alignment.
  - "Go Back" button (left) changed to a standard `OutlinedButton` (no variant) for less visual prominence.
  - "Cancel Job" button (right, destructive) remains a `PrimaryButton` with `variant='error'`.
  - Removed full-width styling from individual buttons, allowing them to size naturally within the new row container.
- **Refactored Comments Section into `JobComments.tsx` Component:**
  - Created new component `components/job/JobComments.tsx`.
  - Moved all comment-related state, handlers (add, edit, delete, modal control), JSX (collapsible section, list, modal), and styles from `app/job/[id].tsx` to `JobComments.tsx`.
  - The new `JobComments` component now encapsulates all comment functionality and is rendered within `app/job/[id].tsx`, receiving necessary props like `jobId`, `jobComments`, `currentUserId`, and `fetchJob`.
- **Documented Theming Strategy:**
  - Analyzed `components/job/CommentModal.tsx` to understand its light/dark mode implementation.
  - Updated `memory-bank/systemPatterns.md` with a detailed description of the standard theming approach, emphasizing the use of `useColorScheme`, themed components from `@/components/Themed`, and helper functions from `hooks/useThemeColor.ts`. This documented pattern is to be followed for all components.
- **Implemented Editable Customer Information in `CustomerInfo.tsx`:**
  - Added functionality to edit Customer Name, Customer Email, Service Address, and Car details.
  - Created new modal components for editing: `components/job/modals/EditNameModal.tsx`, `components/job/modals/EditEmailModal.tsx`, `components/job/modals/EditAddressModal.tsx`, and `components/job/modals/EditCarModal.tsx`.
  - Updated `types.ts` to allow `Car.vin` to be `string | null`.
  - Modified `components/job/CustomerInfo.tsx` to include state for editable fields (including email), edit icons, modal integration, and API save handlers.
  - Ensured `fetchJob` prop is passed from `components/job/JobDetailsAndMapButtons.tsx` to `CustomerInfo.tsx` with the correct type (`() => Promise<void>`).
  - All new UI elements adhere to the established theming strategy.
  - API calls for saving data use `utils/ApiService.ts` and `Alert.alert` for notifications. Service Address updates are now sent to `PATCH /jobs/:id` with the full job object, instead of `PATCH /address/:addressId`.
  - Refined styling in `EditNameModal.tsx` and `EditEmailModal.tsx` to ensure full-width text inputs, consistent with `CommentModal.tsx`, by adjusting `modalView.alignItems` to `stretch`.
- **Updated `components/job/CommentItem.tsx` for Condensed Layout:**
  - Reduced padding, margins, font sizes, and line heights to make individual comments take up less vertical space.
  - Corrected the import path for the `User` type from `contexts/AuthContext` to `types` to resolve a TypeScript error.
- **Refactored and Standardized `Card` Component:**
  - Relocated `Card.tsx` from `components/common/` to `components/Card.tsx`.
  - Updated `Card.tsx` to use the standard page background color (`useThemeColor({}, 'background')`), a theme-aware border, and a theme-aware shadow (new `shadow` property added to `constants/Colors.ts`).
  - Standardized `Card` usage in `app/dashboard/create-job.tsx`, replacing local styles with the shared component.
  - Updated `app/dashboard/account.tsx` to use the new `Card` import path and ensured its internal text elements correctly use themed colors.
  - Updated `components/Typography.tsx` (`LabelText`) to rely on `ThemedText` for color, ensuring consistency.
- **Refactored Discounts Feature:**
  - Updated `types.ts` with `ApiDiscountCode` and `NewDiscountData` types for the new discount functionality.
  - Created `components/job/DiscountList.tsx` to display the list of discounts and handle removal confirmation.
  - Created `components/job/modals/DiscountFormModal.tsx` to provide a comprehensive form for adding discounts, including support for fixed amounts, percentages, and fetching/using predefined discount codes. It handles internal state for form inputs, fetches discount codes from `/discount-codes/active`, calculates discount impacts, and provides validation.
  - Refactored `components/job/Discounts.tsx` to:
    - Utilize the new `DiscountList` and `DiscountFormModal` components.
    - Calculate `lineItemsTotal` (from `job.JobLineItems`) and `discountsTotal`.
    - Pass `jobTotalBeforeDiscounts` (which is `lineItemsTotal`) to the `DiscountFormModal`.
    - Manage loading states and API interactions for adding/removing discounts.
    - Use the standard `Card` component for its main layout.
  - Ensured all new components adhere to theming and project patterns.
- **Added Job Creation page**
  - Created `app/dashboard/create-job.tsx` for the job creation interface.
  - Implemented form elements for job details, including customer information, service address, and vehicle details.
  - Integrated validation and error handling for form submissions.
  - Integrated Address Autocomplete using Google Places API.
  - Integrated Date/Time picker for job scheduling.
  - Integrated Customer Search functionality and New Customer Form to select existing customers or create new ones.
- **Implemented Custom Address Autocompletion (using `expo-crypto`):**
  - Uninstalled `uuid` and `@types/uuid`.
  - Installed `expo-crypto`.
  - Updated `app/dashboard/create-job.tsx` to use `Crypto.randomUUID()` for Google Places API session tokens.
  - Retained custom logic for fetching suggestions (Google Places Autocomplete API) and details (Google Places Details API) via `fetch`.
  - Suggestions are displayed in a `View` with `.map()`, replacing the `FlatList` to avoid the nested VirtualizedList warning.
  - Changed the Service `DropDownPicker`'s `listMode` to `'MODAL'` to also avoid the nested VirtualizedList warning.
- **Refactored DateTimePicker for Job Creation:**
  - Updated `app/dashboard/create-job.tsx` to use the imperative `DateTimePickerAndroid.open()` API for Android, similar to the pattern in `components/job/ArrivalTime.tsx`.
  - This involves separate chained calls for date and then time selection on Android.
  - For iOS, the existing declarative `DateTimePicker` with `mode="datetime"` is retained.
  - This change aims to provide a more stable date/time picking experience on Android and resolve the "Cannot read property 'dismiss' of undefined" error.
- **Fixed Location Update Interval in `hooks/useLocation.ts`:**
  - Identified that the `apiService.post('/user/geolocation', ...)` call was not repeating at the intended `UPDATE_INTERVAL`.
  - The issue was caused by `pendingUpdateRef.current` being reset with a 1-second delay via `setTimeout` in the `finally` block of `updateServerLocation`.
  - Modified `updateServerLocation` to reset `pendingUpdateRef.current = false` immediately within the `finally` block, removing the `setTimeout`. This allows subsequent location updates from `watchPositionAsync` to proceed without unnecessary skips, ensuring the API call frequency aligns better with `UPDATE_INTERVAL`.
- **Implemented Background Location Tracking using `expo-task-manager`:**
  - Installed `expo-task-manager` package.
  - Modified `hooks/useLocation.ts`:
    - Added `TaskManager.defineTask` at the top level to define `background-location-task`. This task handles sending location updates to the `/user/geolocation` API endpoint.
    - Updated `checkPermissions` to request and verify both foreground and background location permissions.
    - Replaced `Location.watchPositionAsync` with `Location.startLocationUpdatesAsync(LOCATION_TASK_NAME, ...)` to initiate background-capable location tracking.
    - Updated `stopLocationUpdates` to use `Location.stopLocationUpdatesAsync(LOCATION_TASK_NAME)`.
    - Removed all `console.log` statements and minimized comments as requested.
  - Confirmed `app.json` already had necessary configurations for background location modes on iOS and Android.
- **Refactored Styling for Login and Registration Pages:**
  - Modified `styles/globalStyles.ts`:
    - Changed `inputContainer` background to `transparent`.
    - Added new theme-aware structural styles: `themedFormInput`, `themedPasswordInputWrapper`, `themedPasswordTextInput`.
    - Removed old `input`, `inputPrice` styles and hardcoded color from `label` style.
  - Updated `app/register.tsx` and `app/login.tsx`:
    - Consistently used `globalStyles.inputContainer` for input field wrappers.
    - Applied new global input styles (`themedFormInput`, `themedPasswordInputWrapper`, `themedPasswordTextInput`) with inline themed colors.
    - Ensured `LabelText` is used for labels where appropriate.
- **Implemented User Registration:**
  - Created `app/register.tsx` with a registration form (First Name, Last Name, Email, Phone, Password, Confirm Password).
  - First Name and Last Name fields are displayed on the same row.
  - Implemented client-side validation: required fields, password match, strong password policy.
  - Integrated API call to `POST /users/signup`.
  - On success, navigates to `/login` with email pre-filled.
  - Displays API errors.
  - Added navigation link to login page.
  - Ensured consistent theming for light/dark modes.
  - Added `register` screen to `app/_layout.tsx` with `headerShown: false`.
- **Updated `app/login.tsx`:**
  - Added functionality to accept an `email` parameter for autofill.
  - Added a navigation link to the new `/register` page.
  - Improved theming consistency.
  - Standardized password visibility toggle state and function names to match `app/register.tsx` (`isPasswordVisible`, `togglePasswordVisibility`).
- **Updated Login and Registration Page Styling:**
  - Added a new `brand` color (`#252d3a`) to `constants/Colors.ts`.
  - Updated `app/login.tsx` and `app/register.tsx` to use this `brand` color for their main background.
  - Corrected styling for password input fields in `app/register.tsx` to ensure proper theme-aware rendering.
  - Ensured both pages are scrollable using `ScrollView`.
- **Enhanced Job File Uploads with Camera Integration:**
  - Installed `expo-camera` dependency.
  - Created `components/job/CameraCaptureModal.tsx` to provide a dedicated camera interface for taking photos. This modal handles camera permissions, displays a preview, and allows capturing a single image.
  - Modified `components/job/JobFiles.tsx`:
    - Replaced the single "Upload File(s)" button with two icon buttons: a "camera" icon to launch `CameraCaptureModal.tsx` and a "folder" icon to use the existing `expo-document-picker` functionality.
    - Integrated the `CameraCaptureModal` and its callback to handle uploading the captured image.
    - The document picker is now configured to primarily suggest images (`type: ['image/*']`).
  - Removed all code comments from `components/job/CameraCaptureModal.tsx` and `components/job/JobFiles.tsx` as per user request.
  - Updated `app.json` by adding the `expo-camera` plugin to ensure correct camera permissions are configured for iOS and Android. The plugin includes a usage description: "Allow $(PRODUCT_NAME) to access your camera to take photos for job documentation."
- **Implemented Lost Password Page:**
  - Installed `react-native-webview` dependency.
  - Created `app/lost-password.tsx` screen featuring a `WebView` pointing to `https://app.24hrcarunlocking.com/reset-password`.
  - Added a "Back to Login" button on the `lost-password` screen.
  - Added a "Forgot Password?" link on `app/login.tsx` navigating to the new screen.
  - Included `lost-password` in the root navigation layout (`app/_layout.tsx`) with `headerShown: false`.
- **Implemented Phone Number Formatting on Registration Page:**
  - Added a `formatPhoneNumber` utility function to `utils/strings.ts` to format numbers as `XXX-XXX-XXXX`.
  - Updated `app/register.tsx` to use this utility for the phone number input field, providing real-time formatting as the user types.
  - Set `maxLength={12}` for the phone input field.
- **Account Deletion Request:**
  - Added a "Delete Account" button to the account screen (`app/dashboard/account/index.tsx`).
  - The button triggers a confirmation dialog before sending a `POST` request to `/account/delete`.
  - The user is notified of the request's success or failure via an alert.
  - The user is not logged out upon successful request.
- **Updated Account Deletion Endpoint:**
  - Changed the API call in `app/dashboard/account/index.tsx` from `apiService.post('/account/delete')` to `apiService.delete('/account/delete')` to match the API documentation.
- **Enhanced Account Deletion with Confirmation Modal:**
    - Created a new `DeleteAccountModal.tsx` component in `components/account/`.
    - This modal requires the user to type "delete" to confirm the action.
    - Replaced the standard `Alert.alert` with the new custom modal in `app/dashboard/account/index.tsx`.
    - The user is now logged out and redirected to the login screen after a 1-second delay for a smoother user experience.
- **Refactored `app/dashboard/index.tsx` for Improved Layout and Production Readiness:**
  - Created a dedicated `JobsFilter.tsx` component in `components/dashboard/` to encapsulate the filtering and sorting dropdowns.
  - Moved all related state, styles, and logic for the filters into the new `JobsFilter` component, making it self-contained and reusable.
  - Corrected TypeScript prop types in `JobsFilter.tsx` to use `Dispatch<SetStateAction<string>>` for state setters.
  - Simplified the `JobsScreen` (`app/dashboard/index.tsx`) by removing the filter-specific logic and replacing it with the new `JobsFilter` component.
  - Streamlined the layout and removed redundant styling from `JobsScreen`, resulting in cleaner, more maintainable code.
- **Standardized "My Jobs" Page Layout:**
  - Refactored `app/dashboard/index.tsx` to align with the standard page layout used in `app/dashboard/account/index.tsx`.
  - Replaced the root `View` with a theme-aware `ScrollView`.
  - Wrapped the page content (`JobsFilter` and `JobsList`) within the standardized `Card` component to ensure consistent container styling, padding, and spacing.
- **Centered Account Modals:**
  - Corrected a layout issue in `components/account/EditNameModal.tsx`, `components/account/EditPhoneModal.tsx`, and `components/account/EditEmailModal.tsx` to ensure they are properly centered.
  - The final fix involved removing the `margin` property from the `modalView` style while retaining the `width: '90%'` on the wrapping `TouchableOpacity`, allowing the parent `centeredView` to manage alignment correctly without distorting the modal's internal layout.
- **Fixed Video Recording in `CameraCaptureModal.tsx`:**
  - Refactored the `handleCapture` function to correctly handle video recording without blocking the UI.
  - The `await` on `recordAsync()` was replaced with a promise-based approach (`.then()`, `.catch()`, `.finally()`).
  - This ensures the UI remains responsive during recording and that the recording can be stopped correctly.
  - State management for `isRecording` and `isProcessing` was updated to provide accurate user feedback.
- **Standardized "Create Job" Page Layout:**
  - Refactored `app/dashboard/create-job.tsx` to add consistent padding to the main container.
  - Wrapped the page in a `SafeAreaView` to prevent the tab navigator from obscuring content at the bottom of the screen.
  - Added a back button to the header of the `create-job` screen in `app/dashboard/_layout.tsx`.
  - Reduced the font size of the `CardTitle` component in `components/Typography.tsx` to make the titles less prominent.
  - This change aligns the page's layout with other screens, ensuring a uniform look and feel.
- **Added Loading Spinner to File Viewer:**
  - Updated `components/job/JobFiles.tsx` to display a loading spinner (`ActivityIndicator`) in the `FileViewerModal` while images or videos are loading.
  - Added an `isLoading` state to the modal.
  - Used `onLoadStart` and `onLoadEnd` for the `Image` component.
  - Used a `useEffect` hook to monitor the `player.status` for the `Video` component.
- **Added Flash Control to Camera:**
  - Updated `components/job/CameraCaptureModal.tsx` to include a flash control button.
  - Added state to manage the flash mode ('on', 'off', 'auto') for photos and the torch mode for videos.
  - The flash setting is now passed to the `CameraView` component using the `flash` and `enableTorch` props.
- **Standardized Single Deposit Page Layout:**
  - Refactored `app/dashboard/account/deposits/[id].tsx` to align with the project's styling patterns.
  - Replaced local text styles with standardized `HeaderText` and `LabelText` from `components/Typography.tsx`.
  - Encapsulated all content sections within `Card` components for a consistent look and feel.
  - Adjusted page padding to be consistent with other screens.
- **Fixed Customer Name Update Bug:**
  - Modified `components/job/modals/EditNameModal.tsx` to have separate input fields for "First Name" and "Last Name".
  - Updated the modal to parse the full name into first and last names on opening and to save them as a `{ firstName, lastName }` object.
  - Adjusted `components/job/CustomerInfo.tsx` to handle the new object structure from the modal and send the correct data (`firstName`, `lastName`) to the backend API, resolving the update failure.
- **Fixed Notifications Screen Crash:**
  - Resolved a "Maximum update depth exceeded" error on the notifications screen after a second attempt.
  - The initial fix using `useCallback` was insufficient due to a circular dependency.
  - The final, robust fix involved refactoring the `markAsRead` and `markAllAsRead` functions in `NotificationsContext.tsx` to use the functional update form of `setState`.
  - This removed the `notifications` state dependency from the `useCallback` hooks, making the function references truly stable and definitively breaking the infinite re-render loop.
- **Implemented Pull-to-Refresh on Job Details Page:**
  - Added `RefreshControl` to the `ScrollView` in `app/job/[id].tsx`.
  - Implemented the `onRefresh` handler to refetch job data.
  - Added `refreshing` state to manage the refresh indicator.
- **Fixed Push Notification Subscription Flow:**
  - Corrected a bug in `hooks/useNotifications.ts` where the registration logic only ran on initial app load, not after user login. The `useEffect` dependency array was updated to include `auth.session`.
  - Resolved a subsequent issue where the logout function in `contexts/Auth-Context.tsx` was blocked on simulators by an attempt to unsubscribe from notifications. The logic was updated to ensure logout proceeds smoothly on all devices.
  - Removed a faulty `Device.isDevice` check that was preventing the permission prompt from appearing in certain development environments.
- **Implemented Email Paycheck Feature:**
  - Added an email icon button to each paycheck item on the `app/dashboard/account/paychecks/index.tsx` screen.
  - Implemented the `handleEmailPaycheck` function to call the `POST /paychecks/:paycheckId/email` endpoint.
  - Added loading and feedback (success/error alerts) to the user interface.
- **Optimized Background Location Tracking:**
  - Addressed a potential flooding issue where the background location task could send a "flurry" of requests if the OS batched multiple location updates.
  - Modified `hooks/useLocation.ts` to process only the single most recent location update from the batch provided by `expo-task-manager`, instead of iterating through all of them.
  - Implemented a lightweight in-memory throttle (`lastBackgroundRequest` variable) to limit background location updates to a maximum of one request every 15 seconds, preventing server overload even if the OS triggers the task frequently.
- **Implemented Background Fetch Heartbeat:**
  - Integrated `expo-background-fetch` to run a periodic (15-minute) background task (`BACKGROUND_FETCH_TASK`) in `contexts/LocationContext.tsx`.
  - This "heartbeat" task acts as a watchdog:
    - It checks if the user is clocked in (using `AsyncStorage` persistence).
    - It verifies if the primary location service (`LOCATION_TASK_NAME`) is running.
    - If the user is clocked in but the service has stopped (e.g., due to OS suspension), it automatically restarts the location updates.
  - This adds a critical layer of redundancy for fleet monitoring, ensuring that location tracking remains active even in adverse OS conditions.
  - Refactored `UPDATE_CONFIG` in `contexts/LocationContext.tsx` to be accessible by both the component and the background tasks.
  - Updated `startLocationUpdates` and `stopLocationUpdates` to register/unregister the background fetch task alongside the location service.
- **Fixed Android Crash in Location Service:**
  - Added a defensive check in `startLocationUpdates` to detect if the location task is registered but not tracking.
  - If this stale state is detected, the task is explicitly unregistered using `TaskManager.unregisterTaskAsync(LOCATION_TASK_NAME)` before attempting to restart it.
  - This resolves a `java.lang.NullPointerException` related to `SharedPreferences` on Android, ensuring the task starts with a clean state.

## Next Steps

- **Verification:** Monitor the "heartbeat" logs in development to confirm the background fetch task triggers as expected (approx. every 15 mins).
- **Testing:** Thoroughly test the new deep linking functionality for both push notifications and in-app notifications on both iOS and Android.
- **Identify and document any `Known Issues`** that arise during testing or further development.
- **Continue Project Work:** Proceed with the next development task based on the priorities outlined in `projectbrief.md` and `progress.md` once Memory Bank is up-to-date and current features are stable.
- Continuously update all Memory Bank files as new information is gathered or decisions are made.

## Active Decisions & Considerations

- Prioritizing comprehensive Memory Bank population before diving deep into feature development to ensure a solid understanding of the existing project.
- Determining the level of detail required for each Memory Bank section to be useful without being overly verbose.

## Important Patterns & Preferences

- The project relies heavily on Expo for its build system, development tools, and core native functionalities.
- Custom-built UI components are preferred over external libraries.
- State management is handled via React Context API for global state and local component state.
- `README.md` serves as a critical source of initial setup and operational information.

## Learnings & Project Insights

- The `README.md` file provided significant initial context for `techContext.md`, highlighting its importance for onboarding and understanding development practices.
- A structured approach to populating the Memory Bank, by addressing each core file systematically, helps ensure comprehensive coverage.
- Iterative refinement of Memory Bank documents will be necessary as deeper insights into the codebase are gained.
- The component review (May 14, 2025) provided a good overview of the existing UI building blocks. Key takeaways include:
  - A consistent theming strategy is emerging based on `components/Themed.tsx` and `hooks/useThemeColor.ts`.
  - A set of standardized buttons (`components/Buttons.tsx`) and typography elements (`components/Typography.tsx`) are available.
  - Job-specific components in `components/job/` are generally well-structured and handle significant pieces of functionality.
  - Some older components or specific style instances are not fully theme-aware and could be refactored for better consistency.
  - Minor redundancies in functionality were noted (e.g., two `CurrencyInput` components, overlapping map button logic), offering future consolidation opportunities.
- The primary mechanism for resolving potential 401 errors during initial user data fetching (`/users/me`) is the migration of user fetching logic directly into `AuthContext.tsx`. This ensures that `apiService` is correctly configured with the session token (derived from the `session` state) by `AuthContext` itself before it attempts to fetch user data. The presence of a valid `session` is the key condition for proceeding with user data fetching.
